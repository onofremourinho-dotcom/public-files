<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapeamento Tecnol√≥gico - Recebimento & Expedi√ß√£o</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3c72;
            --secondary: #2a5298;
            --accent: #4CAF50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196F3;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 15px;
            opacity: 0.95;
        }
        
        /* barra de abas com rolagem no mobile */
        .tab-system {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .tab-button {
            flex-shrink: 0; 
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            min-width: 130px; 
        }

        .tab-button:hover {
            background: #f0f0f0;
        }

        .tab-button.active {
            background: white;
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .content {
            padding: 30px;
            display: none;
        }

        .content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-card {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .question-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.1);
        }
        
        .section-interviewee {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid var(--info);
        }

        .question-id {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .question-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .sub-question {
            margin-left: 20px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .sub-question:before {
            content: "‚Üí ";
            color: var(--primary);
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
            font-size: 14px;
        }

        textarea, select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            transition: border 0.3s;
        }

        textarea:focus, select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(30, 60, 114, 0.2);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .impacto-info {
            background: #e3f2fd;
            padding: 12px;
            border-left: 4px solid var(--info);
            margin-top: 15px;
            border-radius: 4px;
            font-size: 13px;
            color: #1565c0;
        }

        .navigation {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(30, 60, 114, 0.3);
        }

        .btn-success {
            background: var(--accent);
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .review-screen {
            display: none;
        }

        .review-screen.active {
            display: block;
        }

        .review-summary {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .review-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-left: 4px solid var(--primary);
            border-radius: 4px;
        }

        .review-item-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .review-item-value {
            color: #666;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .report-screen {
            display: none;
            padding: 40px;
        }

        .report-screen.active {
            display: block;
        }

        .report-title {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 20px;
            border-bottom: 3px solid var(--accent);
            padding-bottom: 15px;
        }

        .report-section {
            margin-bottom: 40px;
        }

        .report-section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
            padding-left: 15px;
        }

        .risk-matrix {
            margin: 20px 0;
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
        }

        .risk-matrix th, .risk-matrix td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        .risk-matrix th {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }

        .gap-item {
            margin-bottom: 15px;
            padding: 12px;
            background: #fff3cd;
            border-left: 4px solid #ff9800;
            border-radius: 4px;
        }

        .gap-criticality {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 12px;
            margin-right: 10px;
        }

        .criticality-alto { background: #f44336; color: white; }
        .criticality-medio { background: #ff9800; color: white; }
        .criticality-baixo { background: #4CAF50; color: white; }

        .print-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 20px 0;
        }
        
        .print-section-btn {
            background: #5A5A5A;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 14px;
            transition: background 0.3s;
        }

        .print-section-btn:hover {
             background: #333;
        }

        .progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--primary) 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        #reviewSummaryForReport {
            max-height: none !important; 
            overflow-y: visible !important;
            font-size: 12px;
            background: #f9f9f9;
            padding-top: 10px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .container { border-radius: 0; }
            .tab-system { 
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            .tab-button { 
                flex-shrink: 0; 
                min-width: 120px; 
                font-size: 12px;
            }
            .header h1 { font-size: 24px; }
            .btn { font-size: 14px; }
            .content { padding: 20px; }
            #reviewContent { 
                max-height: 400px;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Mapeamento Tecnol√≥gico</h1>
            <p>Recebimento e Expedi√ß√£o - Planta Tatu√≠</p>
            <p style="font-size: 13px; margin-top: 10px;">Levantamento de Infraestrutura, Sistemas e Integra√ß√µes</p>
        </div>

        <div class="tab-system" id="tabSystem">
            <button class="tab-button active" onclick="switchTab('etapa1')">1. Recebimento Inicial</button>
            <button class="tab-button" onclick="switchTab('etapa2')">2. Confer√™ncia F√≠sica</button>
            <button class="tab-button" onclick="switchTab('etapa3')">3. Diverg√™ncias</button>
            <button class="tab-button" onclick="switchTab('etapa4')">4. Armazenagem/Expd</button>
            <button class="tab-button" onclick="switchTab('etapa5')">5. Invent√°rio</button>
            <button class="tab-button" onclick="switchTab('etapa6')">6. Infraestrutura</button>
            <button class="tab-button" onclick="switchTab('etapa7')">7. An√°lise</button>
        </div>
        
        <!-- ETAPA 1 -->
        <div id="etapa1" class="content active">
            <h2 style="color: var(--primary); margin-bottom: 20px;">üìå Etapa 1: Recebimento Inicial (Portaria/Desembarque)</h2>
            <button class="print-section-btn" type="button" onclick="exportSectionAsHtml('etapa1', 'Etapa 1: Recebimento Inicial')">üìÑ Salvar PDF desta etapa</button>

            <div class="form-group section-interviewee">
                <label class="form-label" style="color: #1565c0; margin-bottom: 5px;">üë§ Entrevistado desta Se√ß√£o:</label>
                <input type="text" name="entrevistado_etapa1" placeholder="Nome de quem respondeu esta etapa">
            </div>
            
            <div class="progress-bar"><div class="progress-fill" style="width: 14%;"></div></div>

            <form id="form1">
                <div class="question-card">
                    <div class="question-id">R1</div>
                    <div class="question-title">Como funciona o recebimento inicial de NF-e?</div>
                    <div class="sub-question">O Cockpit Edoc est√° recebendo 100% das NF-e corretamente?</div>
                    <div class="sub-question">H√° erros recorrentes na integra√ß√£o que requerem corre√ß√£o manual?</div>
                    <div class="sub-question">Qual √© a frequ√™ncia de atrasos ou falhas nesta etapa?</div>

                    <div class="form-group">
                        <label class="form-label">üìù Descreva como funciona o recebimento de NF-e</label>
                        <textarea name="r1_descricao" id="r1_descricao" placeholder="Detalhe o processo, taxas de erro, atrasos..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üìä Frequ√™ncia de erros/atrasos</label>
                        <select name="r1_frequencia" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="nenhum">Nenhum - funciona 100%</option>
                            <option value="raro">Raro (menos de 1x/m√™s)</option>
                            <option value="ocasional">Ocasional (1-2x/semana)</option>
                            <option value="frequente">Frequente (quase di√°rio)</option>
                            <option value="critico">Cr√≠tico (di√°rio/bloqueia opera√ß√£o)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‚ö†Ô∏è Qual √© o impacto quando falha?</label>
                        <textarea name="r1_impacto" placeholder="Tempo de parada, horas perdidas, custo estimado..."></textarea>
                    </div>

                    <div class="impacto-info">
                        <strong>üí° Impacto esperado:</strong> Direto - atraso em todo processo de recebimento
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R2</div>
                    <div class="question-title">O Check List App (Intranet) funciona adequadamente?</div>
                    <div class="sub-question">Qual √© a confiabilidade da conex√£o Wi-Fi na portaria?</div>
                    <div class="sub-question">H√° dificuldades de acesso ou performance?</div>
                    <div class="sub-question">Todos os operadores conseguem usar facilmente?</div>

                    <div class="form-group">
                        <label class="form-label">üìù Descreva a experi√™ncia com Check List App</label>
                        <textarea name="r2_descricao" placeholder="Facilidade de uso, velocidade, falhas, problemas..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üì° Qualidade da Wi-Fi nesta √°rea</label>
                        <select name="r2_wifi" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="excelente">Excelente - sinal forte sempre</option>
                            <option value="bom">Bom - funciona bem, raros problemas</option>
                            <option value="medio">M√©dio - alguns pontos fracos</option>
                            <option value="ruim">Ruim - quedas frequentes</option>
                            <option value="critico">Cr√≠tico - n√£o funciona nesta √°rea</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>üí° Impacto esperado:</strong> M√©dio - atraso de registro
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R3</div>
                    <div class="question-title">Como funciona o bipar de NF-e em portaria?</div>
                    <div class="sub-question">Qual device √© usado? (PDA, tablet, computador)</div>
                    <div class="sub-question">Que tecnologia √© usada? (QR, c√≥digo de barras)</div>
                    <div class="sub-question">Taxa de sucesso? H√° erros frequentes?</div>

                    <div class="form-group">
                        <label class="form-label">üìù Descreva o processo de bipar</label>
                        <textarea name="r3_descricao" placeholder="Device usado, tecnologia, taxa de sucesso..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‚öôÔ∏è Device utilizado</label>
                        <input type="text" name="r3_device" placeholder="Ex: Zebra MC33, iPad, Computador...">
                    </div>

                    <div class="form-group">
                        <label class="form-label">üìä Confiabilidade do processo</label>
                        <select name="r3_confiabilidade" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="100">100% - nunca falha</option>
                            <option value="95">95-99% - raro erro</option>
                            <option value="85">85-94% - ocasional erro</option>
                            <option value="75">75-84% - frequente erro</option>
                            <option value="menos75">Menos de 75% - muito inst√°vel</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>üí° Impacto esperado:</strong> Alto - bloqueio de entrada
                    </div>
                </div>

                <div class="navigation">
                    <button type="button" class="btn btn-secondary" disabled>‚Üê Anterior</button>
                    <button type="button" class="btn btn-primary" onclick="switchTab('etapa2')">Pr√≥xima ‚Üí</button>
                </div>
            </form>
        </div>

        <!-- ETAPA 2 -->
        <!-- (todo o resto das etapas permanece exatamente igual ao que voc√™ enviou;
             por quest√£o de espa√ßo n√£o vou repetir tudo aqui, mas √© s√≥ colar o restante
             do seu HTML original a partir da <div id="etapa2"...> at√© antes do <script> ) -->

        <!-- ... cole aqui as divs etapa2, etapa3, etapa4, etapa5, etapa6, etapa7, reviewScreen e reportScreen
             exatamente como est√£o no seu c√≥digo que voc√™ enviou ... -->

    </div>

    <script>
        const STORAGE_KEY = 'currentSurveyData'; 
        let formData = {}; 

        document.addEventListener('DOMContentLoaded', () => {
             loadDataFromLocalStorage(); 
             attachAutoSave(); 
             updateRiskMatrix(); 
        });
        
        function saveDataToLocalStorage() {
            let currentData = {};
            document.querySelectorAll('form, .content').forEach(container => {
                container.querySelectorAll('input, textarea, select').forEach(field => {
                    if (field.name) {
                        currentData[field.name] = field.value; 
                    }
                });
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(currentData));
            formData = currentData; 
        }

        function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) {
                const dt = document.getElementById('dataEntrevista');
                if (dt) dt.valueAsDate = new Date(); 
                return;
            }
            
            const data = JSON.parse(savedData);
            formData = data; 
            
            for (const [key, value] of Object.entries(data)) {
                const field = document.getElementsByName(key)[0];
                if (field) {
                    field.value = value;
                }
            }
        }

        function attachAutoSave() {
            document.querySelectorAll('input, textarea, select').forEach(element => {
                element.addEventListener('change', saveDataToLocalStorage);
            });
        }

        function switchTab(tabId) {
            saveDataToLocalStorage(); 
            
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');

            const tabName = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
            if (tabName) tabName.classList.add('active');

            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function getFieldLabel(key, field) {
            let label = null;
            
            const labelMap = {
                'entrevistado_etapa1': 'üë§ Entrevistado - Etapa 1',
                'entrevistado_etapa2': 'üë§ Entrevistado - Etapa 2',
                'entrevistado_etapa3': 'üë§ Entrevistado - Etapa 3',
                'entrevistado_etapa4': 'üë§ Entrevistado - Etapa 4',
                'entrevistado_etapa5': 'üë§ Entrevistado - Etapa 5',
                'entrevistado_etapa6': 'üë§ Entrevistado - Etapa 6',
                'entrevistado_etapa7': 'üë§ Entrevistado - Etapa 7',
                'data_entrevista': 'üìÖ Data de Preenchimento (Geral)',
                'observacoes_finais': 'üìù Observa√ß√µes Finais (Geral)'
            };
            
            label = labelMap[key];
            if (label) return label;

            if (field) {
                const formGroup = field.closest('.form-group');
                if (formGroup) {
                    const labelEl = formGroup.querySelector('.form-label');
                    if (labelEl) {
                        label = labelEl.innerText.trim();
                    }
                }
            }

            if (!label && field) {
                const questionCard = field.closest('.question-card');
                if(questionCard) {
                    const questionTitle = questionCard.querySelector('.question-title');
                    const questionId = questionCard.querySelector('.question-id');
                    const prefix = questionId ? questionId.innerText + ': ' : '';
                    const fg = field.closest('.form-group');
                    const fieldLabelText = fg && fg.querySelector('.form-label')
                        ? fg.querySelector('.form-label').innerText.replace(/üìù|üìä|üì°|‚öôÔ∏è|üñ®Ô∏è|üñ•Ô∏è|üîÑ|‚ö†Ô∏è|‚è±Ô∏è/g, '').trim()
                        : '';

                    if (questionTitle) {
                        label = prefix + questionTitle.innerText + (fieldLabelText && !questionTitle.innerText.includes(fieldLabelText) ? ' (' + fieldLabelText + ')' : '');
                    }
                }
            }
            
            return label || key.toUpperCase(); 
        }
        
        function getFieldDisplayValue(key, field) {
            let value = formData[key] || '';
            let displayValue = value;
            if (field && field.tagName === 'SELECT') {
                const selectedOption = field.options[field.selectedIndex];
                if (selectedOption) {
                    displayValue = selectedOption.text;
                }
            }
            return displayValue;
        }

        function reviewAnswers() {
            saveDataToLocalStorage(); 
            
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) {
                alert('Erro: N√£o foi poss√≠vel ler os dados salvos.');
                return;
            }
            formData = JSON.parse(savedData);
            
            let reviewHTML = '';
            const allFields = document.querySelectorAll('input, textarea, select');
            
            allFields.forEach(field => {
                const key = field.name;
                const value = formData[key] || '';
                
                if (value && value.trim() !== '') {
                    const label = getFieldLabel(key, field);
                    const displayValue = getFieldDisplayValue(key, field);

                    reviewHTML += `
                        <div class="review-item">
                            <div class="review-item-title">${escapeHtml(label)}</div>
                            <div class="review-item-value">${escapeHtml(displayValue)}</div>
                        </div>
                    `;
                }
            });

            document.getElementById('reviewContent').innerHTML = reviewHTML;
            document.getElementById('reviewScreen').classList.add('active');
            document.getElementById('tabSystem').style.display = 'none';
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));

            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function backToForm() {
            document.getElementById('reviewScreen').classList.remove('active');
            document.getElementById('tabSystem').style.display = 'flex';
            switchTab('etapa7');
        }

        /* SALVAR PDF POR ETAPA ‚Äì exportSectionAsHtml permanece igual ao seu */

        function exportSectionAsHtml(sectionId, sectionTitle) {
            saveDataToLocalStorage(); 
            const section = document.getElementById(sectionId);
            
            if (!section) {
                alert('Erro: Se√ß√£o n√£o encontrada.');
                return;
            }

            const intervieweField = section.querySelector(`input[name="entrevistado_${sectionId}"]`);
            const interviewedName = intervieweField ? intervieweField.value || 'N√ÉO INFORMADO' : 'N√ÉO INFORMADO';
            
            const sectionFields = section.querySelectorAll('input, textarea, select');
            let reviewHTML = '';
            
            sectionFields.forEach(field => {
                const key = field.name;
                const value = formData[key] || '';
                
                if (key === `entrevistado_${sectionId}`) return; 
                
                if (value && value.trim() !== '') {
                    const label = getFieldLabel(key, field);
                    const displayValue = getFieldDisplayValue(key, field);

                    reviewHTML += `
                        <div class="review-item" style="margin-bottom: 10px; padding: 10px; border-left: 4px solid #2a5298; background: #f0f7ff; border-radius: 4px;">
                            <div class="review-item-title" style="font-weight: bold; color: #1e3c72; font-size: 13px; margin-bottom: 3px;">${escapeHtml(label)}</div>
                            <div class="review-item-value" style="color: #333; font-size: 12px; white-space: pre-wrap;">${escapeHtml(displayValue)}</div>
                        </div>
                    `;
                }
            });
            
            if (reviewHTML === '') {
                alert('Aten√ß√£o: Esta etapa n√£o tem respostas preenchidas para salvar. Preencha os dados primeiro.');
                return;
            }

            const printContent = document.createElement('div');
            printContent.id = 'tempPrintSection';
            printContent.innerHTML = `
                <div style="padding: 20px; max-width: 800px; margin: 0 auto;">
                    <div style="background: #1e3c72; color: white; padding: 20px; border-radius: 6px 6px 0 0; margin-bottom: 20px; text-align: center;">
                        <h1 style="font-size: 24px; margin: 0;">Backup - Mapeamento Tecnol√≥gico</h1>
                        <p>${escapeHtml(sectionTitle)}</p>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 4px; border-left: 4px solid #ff9800; margin-bottom: 20px; font-weight: bold; color: #333; font-size: 14px;">
                        Entrevistado: ${escapeHtml(interviewedName)} | Data do Backup: ${new Date().toLocaleDateString('pt-BR')}
                    </div>
                    
                    ${reviewHTML}
                    
                    <div style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 10px; font-size: 10px; color: #999; text-align: center;">
                        Documento de Backup Gerado pelo Sistema de Mapeamento.
                    </div>
                </div>
            `;
            
            const containerEl = document.querySelector('.container');
            const originalContainerDisplay = containerEl.style.display;
            const originalBodyBackground = document.body.style.background;
            
            containerEl.style.display = 'none';
            document.body.style.background = 'white'; 
            document.body.appendChild(printContent);
            
            setTimeout(() => {
                window.print();
                
                setTimeout(() => {
                    document.body.removeChild(printContent);
                    containerEl.style.display = originalContainerDisplay;
                    document.body.style.background = originalBodyBackground;
                    document.getElementById(sectionId).classList.add('active'); 
                }, 500); 
                
            }, 300);

            alert(`Preparando PDF da ${sectionTitle}. Aguarde o di√°logo de impress√£o aparecer e selecione "Salvar como PDF".`);
        }

        /* ‚úÖ NOVA FUN√á√ÉO: GERA E IMPRIME O PDF FINAL SEM FICAR EM BRANCO */

        function generateAndPrintFinalReport() {
            saveDataToLocalStorage();

            const reportContainer = document.getElementById('reportContent');
            if (!reportContainer || !reportContainer.innerHTML.trim()) {
                alert('Primeiro clique em "Gerar Relat√≥rio Final" antes de gerar o PDF.');
                return;
            }

            const reportHTML = reportContainer.innerHTML;

            const css = `
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: #ffffff;
                    padding: 20px;
                    max-width: 1000px;
                    margin: 0 auto;
                }
                .report-title {
                    font-size: 28px;
                    font-weight: bold;
                    color: #1e3c72;
                    margin-bottom: 20px;
                    border-bottom: 3px solid #4CAF50;
                    padding-bottom: 15px;
                }
                .report-section {
                    margin-bottom: 32px;
                }
                .report-section-title {
                    font-size: 20px;
                    font-weight: 600;
                    color: #2a5298;
                    margin-bottom: 12px;
                    border-left: 4px solid #4CAF50;
                    padding-left: 12px;
                }
                .review-summary {
                    background: #f0f7ff;
                    padding: 16px;
                    border-radius: 8px;
                }
                .review-item {
                    margin-bottom: 10px;
                    padding: 10px;
                    background: #ffffff;
                    border-left: 4px solid #1e3c72;
                    border-radius: 4px;
                }
                .review-item-title {
                    font-weight: 600;
                    color: #1e3c72;
                    margin-bottom: 4px;
                }
                .review-item-value {
                    font-size: 13px;
                    color: #444;
                    white-space: pre-wrap;
                }
                .risk-matrix {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 12px;
                    margin-top: 10px;
                }
                .risk-matrix th, .risk-matrix td {
                    border: 1px solid #ddd;
                    padding: 6px 8px;
                    text-align: center;
                }
                .risk-matrix th {
                    background: #1e3c72;
                    color: #fff;
                }
                .gap-criticality {
                    display: inline-block;
                    padding: 3px 8px;
                    border-radius: 3px;
                    font-weight: bold;
                    font-size: 11px;
                    color: #fff;
                }
                .criticality-alto { background: #f44336; }
                .criticality-medio { background: #ff9800; }
                .criticality-baixo { background: #4CAF50; }
                @page { margin: 15mm; }
            `;

            const printWindow = window.open('', '_blank', 'width=900,height=900');
            if (!printWindow) {
                alert('O navegador bloqueou o pop-up. Libere pop-ups para este site e tente novamente.');
                return;
            }

            printWindow.document.open();
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <title>Relat√≥rio Final - Mapeamento Tecnol√≥gico</title>
                    <style>${css}</style>
                </head>
                <body>
                    ${reportHTML}
                </body>
                </html>
            `);
            printWindow.document.close();

            printWindow.onload = function () {
                printWindow.focus();
                printWindow.print();
                setTimeout(() => {
                    printWindow.close();
                }, 500);
            };
        }

        function generateReport() {
            const criticidades = calculateCriticalities();
            const reportHTML = buildReport(criticidades);

            document.getElementById('reportContent').innerHTML = reportHTML;
            document.getElementById('reportScreen').classList.add('active');
            document.getElementById('reviewScreen').classList.remove('active');
            document.getElementById('tabSystem').style.display = 'none';

            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function newInterview() {
            if (confirm('Deseja iniciar uma nova entrevista? O progresso atual ser√° perdido. Certifique-se de que salvou o PDF da entrevista anterior.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function calculateCriticalities() {
            saveDataToLocalStorage(); 
            
            const criticidades = {};
            criticidades.r1 = calculateGapCriticality('r1_frequencia', 'Alto'); 
            criticidades.r4 = calculateGapCriticality('r4_qualidade', 'Alto'); 
            criticidades.r16 = calculateGapCriticality('r16_dr', 'Cr√≠tico');
            criticidades.r2 = calculateGapCriticality('r2_wifi', 'Medio'); 
            criticidades.r5 = calculateGapCriticality('r5_automacao', 'Alto'); 
            criticidades.r11 = calculateGapCriticality('r11_automacao', 'Alto');
            criticidades.r13 = calculateGapCriticality('r13_automacao', 'Medio');
            criticidades.r15 = calculateGapCriticality('r15_criticidade', 'Alto');
            criticidades.r17 = calculateGapCriticality('r17_risco', 'Medio');
            return criticidades;
        }

        function calculateGapCriticality(fieldName, expectedImpact) {
            const value = formData[fieldName] || '';
            const criticalityMap = {
                'critico': 5, 'ruim': 4, 'frequente': 4, 'nao': 5, '4': 5, 
                'ocasional': 3, 'medio': 3, 'existe': 3, 'parcial': 3, '3': 4,
                'raro': 2, 'bom': 2, '75': 2, '2': 3,
                'nenhum': 1, 'excelente': 1, '100': 1, 'testado': 1, '1': 1,
                '0': 5, '25': 4, '50': 3, '75': 2, '100': 1,
                'manual': 5, 'batch-diario': 4, 'batch-60': 4, 'batch-30': 3, 'batch-5': 2, 'real-time': 1,
            };
            
            let critValue = criticalityMap[value] || 1;
            
            if (fieldName === 'r17_risco') {
                 const riskMap = { '4': 5, '3': 4, '2': 3, '1': 1 };
                 critValue = riskMap[value] || 1;
            }
            
            return critValue;
        }

        function buildReport(criticidades) {
            const data = formData.data_entrevista || new Date().toLocaleDateString('pt-BR');

            const createGapRow = (etapa, id, titulo, impacto) => {
                const critValue = criticidades[id] || 1;
                if (critValue <= 2) return ''; 
                const label = getCriticityLabel(critValue);
                return `
                    <tr>
                        <td>${etapa}</td>
                        <td>${id.toUpperCase()}</td>
                        <td>${titulo}</td>
                        <td><span class="gap-criticality criticality-${label}">${label.toUpperCase()} (${critValue})</span></td>
                        <td>${impacto}</td>
                    </tr>`;
            };

            let html = `
                <div class="report-title">üìä MAPEAMENTO TECNOL√ìGICO - RELAT√ìRIO EXECUTIVO</div>

                <div class="report-section">
                    <div class="report-section-title">üéØ Gaps e Criticidades Identificados (Priorizados)</div>
                    <table class="risk-matrix">
                        <tr>
                            <th>Etapa</th>
                            <th>ID</th>
                            <th>Gap Identificado</th>
                            <th>Criticidade</th>
                            <th>Impacto</th>
                        </tr>
                        ${createGapRow(1, 'r1', 'Integra√ß√£o NF-e com Cockpit', 'Alto - Atraso em todo processo de recebimento')}
                        ${createGapRow(1, 'r2', 'Qualidade Wi-Fi Portaria', 'M√©dio - Atraso de registro')}
                        ${createGapRow(2, 'r4', 'Cobertura Wi-Fi Almoxarifado', 'Alto - Paralisa opera√ß√µes')}
                        ${createGapRow(2, 'r5', 'N√≠vel de Automa√ß√£o Confer√™ncia ABC', 'Alto - Impacta acuracidade de estoque')}
                        ${createGapRow(4, 'r11', 'N√≠vel de Automa√ß√£o Picking', 'Alto - Impacta faturamento e satisfa√ß√£o do cliente')}
                        ${createGapRow(5, 'r13', 'N√≠vel de Automa√ß√£o Invent√°rio', 'M√©dio - Impacta fechamento cont√°bil')}
                        ${createGapRow(6, 'r15', 'Estado dos Coletores/PDA', 'Alto - Paralisa opera√ß√µes')}
                        ${createGapRow(6, 'r16', 'Plano de Disaster Recovery (DR)', 'Cr√≠tico - Paralisa toda opera√ß√£o')}
                        ${createGapRow(6, 'r17', 'Risco de "Sistemas Sat√©lite" (Planilhas)', 'M√©dio - Falta de rastreabilidade e risco de dados')}
                    </table>
                </div>

                <div class="report-section">
                    <div class="report-section-title">üîß Recomenda√ß√µes Imediatas (Baseado nos Gaps)</div>
                    <ul style="margin-left: 20px;">
                        <li><strong>(Cr√≠tico) R16:</strong> Definir e testar urgentemente um Plano de Disaster Recovery para sistemas cr√≠ticos.</li>
                        <li><strong>(Alto) R1, R4, R15:</strong> Realizar site survey de Wi-Fi no Almoxarifado e Portaria; auditar integra√ß√£o de NF-e; planejar substitui√ß√£o ou reparo de PDAs obsoletos.</li>
                        <li><strong>(Alto) R5, R11:</strong> Mapear processos de confer√™ncia e picking para identificar gargalos de automa√ß√£o e evoluir para uso intensivo de WMS/coletor.</li>
                        <li><strong>(M√©dio) R17:</strong> Inventariar todas as planilhas "sat√©lite" e avaliar migra√ß√£o imediata para sistemas oficiais (ex.: Power BI, Power Apps).</li>
                    </ul>
                </div>

                <div class="report-section">
                    <div class="report-section-title">üìç Resumo das Respostas (Incluindo Entrevistados)</div>
                    <div class="review-item" style="background: #fdfdfd;">
                        <strong>Data do Mapeamento:</strong> ${escapeHtml(data)}<br>
                        <strong>Observa√ß√µes Finais:</strong> ${escapeHtml(formData.observacoes_finais || 'N/A')}
                    </div>
                    
                    <div id="reviewSummaryForReport" class="review-summary"></div>
                </div>

                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd; font-size: 12px; color: #999;">
                    <p>Relat√≥rio gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                    <p>Vers√£o: 2.2 (Isolamento Total do PDF Final) | Sistema de Mapeamento Tecnol√≥gico</p>
                </div>
            `;
            
            setTimeout(() => {
                const reviewHTML = document.getElementById('reviewContent').innerHTML;
                const reportReviewEl = document.getElementById('reviewSummaryForReport');
                if (reportReviewEl) {
                    reportReviewEl.innerHTML = reviewHTML;
                    const itemsToRemove = reportReviewEl.querySelectorAll('.review-item-title');
                    itemsToRemove.forEach(item => {
                        if (item.innerText.includes('Data de Preenchimento') || item.innerText.includes('Observa√ß√µes Finais')) {
                            const card = item.closest('.review-item');
                            if (card) card.style.display = 'none';
                        }
                    });
                }
            }, 0);

            return html;
        }

        function getCriticityLabel(value) {
            if (value >= 4) return 'alto'; 
            if (value >= 3) return 'medio';
            return 'baixo';
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateRiskMatrix() {
            saveDataToLocalStorage();
        }

    </script>
</body>
</html>
