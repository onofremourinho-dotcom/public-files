<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapeamento TecnolÃ³gico - Recebimento & ExpediÃ§Ã£o</title>
    <style>
        /* [Seu CSS Original - Mantido para Layout] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3c72;
            --secondary: #2a5298;
            --accent: #4CAF50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196F3;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 15px;
            opacity: 0.95;
        }
        
        .tab-system {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            overflow-x: auto; 
            white-space: nowrap; 
            -webkit-overflow-scrolling: touch; 
        }

        .tab-button {
            flex-shrink: 0; 
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            min-width: 130px; 
        }

        .tab-button:hover {
            background: #f0f0f0;
        }

        .tab-button.active {
            background: white;
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .content {
            padding: 30px;
            display: none;
        }

        .content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-card {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .question-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.1);
        }
        
        .section-interviewee {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid var(--info);
        }

        .question-id {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .question-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .sub-question {
            margin-left: 20px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .sub-question:before {
            content: "â†’ ";
            color: var(--primary);
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
            font-size: 14px;
        }

        textarea, select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            transition: border 0.3s;
        }

        textarea:focus, select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(30, 60, 114, 0.2);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .impacto-info {
            background: #e3f2fd;
            padding: 12px;
            border-left: 4px solid var(--info);
            margin-top: 15px;
            border-radius: 4px;
            font-size: 13px;
            color: #1565c0;
        }

        .navigation {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(30, 60, 114, 0.3);
        }

        .btn-success {
            background: var(--accent);
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .review-screen {
            display: none;
        }

        .review-screen.active {
            display: block;
        }

        .review-summary {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .review-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-left: 4px solid var(--primary);
            border-radius: 4px;
        }

        .review-item-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .review-item-value {
            color: #666;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .report-screen {
            display: none;
            padding: 40px;
        }

        .report-screen.active {
            display: block;
        }

        .report-title {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 20px;
            border-bottom: 3px solid var(--accent);
            padding-bottom: 15px;
        }

        .report-section {
            margin-bottom: 40px;
        }

        .report-section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
            padding-left: 15px;
        }

        .risk-matrix {
            margin: 20px 0;
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
        }

        .risk-matrix th, .risk-matrix td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        .risk-matrix th {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }

        .gap-criticality {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 12px;
            margin-right: 10px;
        }

        .criticality-alto { background: #f44336; color: white; }
        .criticality-medio { background: #ff9800; color: white; }
        .criticality-baixo { background: #4CAF50; color: white; }

        .print-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 20px 0;
        }
        
        .print-section-btn {
            background: #5A5A5A;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 14px;
            transition: background 0.3s;
        }

        .print-section-btn:hover {
             background: #333;
        }

        .progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--primary) 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        #reviewSummaryForReport {
            max-height: none !important; 
            overflow-y: visible !important;
            font-size: 12px;
            background: #f9f9f9;
            padding-top: 10px;
            margin-top: 15px;
        }

        /* --- CORREÃ‡ÃƒO CRÃTICA DO CSS DE IMPRESSÃƒO --- */
        @media print {
            /* 1. Oculta os elementos de navegaÃ§Ã£o e controles, independente do que estÃ¡ ativo */
            .navigation, .tab-system, .header, .print-section-btn, .print-btn, .btn-secondary {
                display: none !important;
            }

            /* 2. Regra para ISOLAR a impressÃ£o de SEÃ‡ÃƒO (quando #tempPrintSection estÃ¡ ativo) */
            body > *:not(.container) {
                display: none !important;
            }
            #tempPrintSection {
                display: block !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            #tempPrintSection * {
                color: #000 !important;
                background-color: transparent !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            /* 3. Regra para a IMPRESSÃƒO FINAL (quando #reportScreen estÃ¡ ativo no .container) */
            .container > *:not(#reportScreen) {
                display: none !important;
            }
            .report-screen.active {
                display: block !important;
                padding: 0 !important;
            }
            .container {
                box-shadow: none !important;
                background: white !important;
                padding: 0 !important;
                margin: 0 auto !important;
                width: 100% !important;
                max-width: 100% !important;
            }
        }

        /* --- CORREÃ‡ÃƒO DO CSS MOBILE (TAB BAR) --- */
        @media (max-width: 768px) {
            .container { border-radius: 0; }
            .tab-system { 
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            .tab-button { 
                flex-shrink: 0; 
                min-width: 120px; 
                font-size: 12px;
            }
            .header h1 { font-size: 24px; }
            .btn { font-size: 14px; }
            .content { padding: 20px; }
            
            #reviewContent { 
                max-height: 400px;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Mapeamento TecnolÃ³gico</h1>
            <p>Recebimento e ExpediÃ§Ã£o - Planta TatuÃ­</p>
            <p style="font-size: 13px; margin-top: 10px;">Levantamento de Infraestrutura, Sistemas e IntegraÃ§Ãµes</p>
        </div>

        <div class="tab-system" id="tabSystem">
            <button class="tab-button active" onclick="switchTab('etapa1')">1. Recebimento Inicial</button>
            <button class="tab-button" onclick="switchTab('etapa2')">2. ConferÃªncia FÃ­sica</button>
            <button class="tab-button" onclick="switchTab('etapa3')">3. DivergÃªncias</button>
            <button class="tab-button" onclick="switchTab('etapa4')">4. Armazenagem/Expd</button>
            <button class="tab-button" onclick="switchTab('etapa5')">5. InventÃ¡rio</button>
            <button class="tab-button" onclick="switchTab('etapa6')">6. Infraestrutura</button>
            <button class="tab-button" onclick="switchTab('etapa7')">7. AnÃ¡lise</button>
        </div>
        
        <div id="etapa1" class="content active">
            <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“Œ Etapa 1: Recebimento Inicial (Portaria/Desembarque)</h2>
            <button class="print-section-btn" type="button" onclick="exportSectionAsHtml('etapa1', 'Etapa 1: Recebimento Inicial')">ğŸ“„ Salvar PDF desta etapa</button>

            
            <div class="form-group section-interviewee">
                <label class="form-label" style="color: #1565c0; margin-bottom: 5px;">ğŸ‘¤ Entrevistado desta SeÃ§Ã£o:</label>
                <input type="text" name="entrevistado_etapa1" placeholder="Nome de quem respondeu esta etapa">
            </div>
            
            <div class="progress-bar"><div class="progress-fill" style="width: 14%;"></div></div>

            <form id="form1">
                <div class="question-card">
                    <div class="question-id">R1</div>
                    <div class="question-title">Como funciona o recebimento inicial de NF-e?</div>
                    <div class="sub-question">O Cockpit Edoc estÃ¡ recebendo 100% das NF-e corretamente?</div>
                    <div class="sub-question">HÃ¡ erros recorrentes na integraÃ§Ã£o que requerem correÃ§Ã£o manual?</div>
                    <div class="sub-question">Qual Ã© a frequÃªncia de atrasos ou falhas nesta etapa?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva como funciona o recebimento de NF-e</label>
                        <textarea name="r1_descricao" id="r1_descricao" placeholder="Detalhe o processo, taxas de erro, atrasos..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“Š FrequÃªncia de erros/atrasos</label>
                        <select name="r1_frequencia" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="nenhum">Nenhum - funciona 100%</option>
                            <option value="raro">Raro (menos de 1x/mÃªs)</option>
                            <option value="ocasional">Ocasional (1-2x/semana)</option>
                            <option value="frequente">Frequente (quase diÃ¡rio)</option>
                            <option value="critico">CrÃ­tico (diÃ¡rio/bloqueia operaÃ§Ã£o)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">âš ï¸ Qual Ã© o impacto quando falha?</label>
                        <textarea name="r1_impacto" placeholder="Tempo de parada, horas perdidas, custo estimado..."></textarea>
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> Direto - atraso em todo processo de recebimento
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R2</div>
                    <div class="question-title">O Check List App (Intranet) funciona adequadamente?</div>
                    <div class="sub-question">Qual Ã© a confiabilidade da conexÃ£o Wi-Fi na portaria?</div>
                    <div class="sub-question">HÃ¡ dificuldades de acesso ou performance?</div>
                    <div class="sub-question">Todos os operadores conseguem usar facilmente?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva a experiÃªncia com Check List App</label>
                        <textarea name="r2_descricao" placeholder="Facilidade de uso, velocidade, falhas, problemas..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“¡ Qualidade da Wi-Fi nesta Ã¡rea</label>
                        <select name="r2_wifi" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="excelente">Excelente - sinal forte sempre</option>
                            <option value="bom">Bom - funciona bem, raros problemas</option>
                            <option value="medio">MÃ©dio - alguns pontos fracos</option>
                            <option value="ruim">Ruim - quedas frequentes</option>
                            <option value="critico">CrÃ­tico - nÃ£o funciona nesta Ã¡rea</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> MÃ©dio - atraso de registro
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R3</div>
                    <div class="question-title">Como funciona o bipar de NF-e em portaria?</div>
                    <div class="sub-question">Qual device Ã© usado? (PDA, tablet, computador)</div>
                    <div class="sub-question">Que tecnologia Ã© usada? (QR, cÃ³digo de barras)</div>
                    <div class="sub-question">Taxa de sucesso? HÃ¡ erros frequentes?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva o processo de bipar</label>
                        <textarea name="r3_descricao" placeholder="Device usado, tecnologia, taxa de sucesso..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">âš™ï¸ Device utilizado</label>
                        <input type="text" name="r3_device" placeholder="Ex: Zebra MC33, iPad, Computador...">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“Š Confiabilidade do processo</label>
                        <select name="r3_confiabilidade" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="100">100% - nunca falha</option>
                            <option value="95">95-99% - raro erro</option>
                            <option value="85">85-94% - ocasional erro</option>
                            <option value="75">75-84% - frequente erro</option>
                            <option value="menos75">Menos de 75% - muito instÃ¡vel</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> Alto - bloqueio de entrada
                    </div>
                </div>

                <div class="navigation">
                    <button type="button" class="btn btn-secondary" disabled>â† Anterior</button>
                    <button type="button" class="btn btn-primary" onclick="switchTab('etapa2')">PrÃ³xima â†’</button>
                </div>
            </form>
        </div>

        <div id="etapa2" class="content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“Œ Etapa 2: ConferÃªncia FÃ­sica (Almoxarifado)</h2>
            <button class="print-section-btn" type="button" onclick="exportSectionAsHtml('etapa2', 'Etapa 2: ConferÃªncia FÃ­sica')">ğŸ“„ Salvar PDF desta etapa</button>


            <div class="form-group section-interviewee">
                <label class="form-label" style="color: #1565c0; margin-bottom: 5px;">ğŸ‘¤ Entrevistado desta SeÃ§Ã£o:</label>
                <input type="text" name="entrevistado_etapa2" placeholder="Nome de quem respondeu esta etapa">
            </div>

            <div class="progress-bar"><div class="progress-fill" style="width: 29%;"></div></div>

            <form id="form2">
                <div class="question-card">
                    <div class="question-id">R4</div>
                    <div class="question-title">Qual Ã© a qualidade da cobertura de rede Wi-Fi?</div>
                    <div class="sub-question">HÃ¡ pontos cegos ou de fraca cobertura?</div>
                    <div class="sub-question">FrequÃªncia de desconexÃµes durante operaÃ§Ãµes?</div>
                    <div class="sub-question">Impacto no tempo de operaÃ§Ã£o quando hÃ¡ problema?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva a cobertura Wi-Fi na Ã¡rea</label>
                        <textarea name="r4_descricao" placeholder="Ãreas de cobertura, pontos cegos, frequÃªncia de desconexÃµes..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“¡ Qualidade geral da Wi-Fi</label>
                        <select name="r4_qualidade" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="1">1 - Excelente (100% cobertura)</option>
                            <option value="2">2 - Bom (95%+ cobertura)</option>
                            <option value="3">3 - AceitÃ¡vel (80-95% cobertura)</option>
                            <option value="4">4 - Ruim (50-80% cobertura)</option>
                            <option value="5">5 - CrÃ­tico (menos de 50%)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">â±ï¸ Downtime mensal estimado (horas)</label>
                        <input type="number" name="r4_downtime" placeholder="Ex: 10">
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> Alto - paralisa operaÃ§Ãµes
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R5</div>
                    <div class="question-title">Como funciona a conferÃªncia da curva ABC?</div>
                    <div class="sub-question">Ã‰ 100% manual ou com suporte de sistema?</div>
                    <div class="sub-question">Qual Ã© o mÃ©todo? (pesagem, contagem, varredura)</div>
                    <div class="sub-question">Tempo mÃ©dio por carga? Taxa de erro?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva o processo de conferÃªncia ABC</label>
                        <textarea name="r5_descricao" placeholder="MÃ©todo, tempo, taxa de erro..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">âš™ï¸ NÃ­vel de automaÃ§Ã£o</label>
                        <select name="r5_automacao" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="100">100% automatizado (sistema decide)</option>
                            <option value="75">75% - sistema valida, operador confirma</option>
                            <option value="50">50% - sistema gera lista, operador confere manual</option>
                            <option value="25">25% - sistema acompanha, mas conferÃªncia Ã© manual</option>
                            <option value="0">0% - totalmente manual, sem sistema</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“Š Taxa de erro/divergÃªncia</label>
                        <input type="number" name="r5_taxa_erro" placeholder="Ex: 2%" min="0" max="100">
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> Alto - impacta acuracidade de estoque
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R6</div>
                    <div class="question-title">Como funciona o OES para caja trailer?</div>
                    <div class="sub-question">CriaÃ§Ã£o Ã© automÃ¡tica ou manual?</div>
                    <div class="sub-question">Tempo para fechar a caja?</div>
                    <div class="sub-question">HÃ¡ integraÃ§Ã£o em tempo real com Check List App?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva o fluxo no OES</label>
                        <textarea name="r6_descricao" placeholder="Como Ã© criada caja, tempo de processamento, sincronizaÃ§Ã£o..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ”„ Tipo de integraÃ§Ã£o OES â†” Check List</label>
                        <select name="r6_integracao" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="real-time">Real-time - sincronizaÃ§Ã£o instantÃ¢nea</option>
                            <option value="batch-5">Batch - sincroniza a cada 5 min</option>
                            <option value="batch-30">Batch - sincroniza a cada 30 min</option>
                            <option value="batch-diario">Batch - sincroniza 1x ao dia</option>
                            <option value="manual">Manual - requer aÃ§Ã£o de operador</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> MÃ©dio - atraso no fechamento de movimentaÃ§Ã£o
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R7</div>
                    <div class="question-title">Como Ã© feita a etiquetagem de materiais?</div>
                    <div class="sub-question">Gerada automaticamente ou impressa sob demanda?</div>
                    <div class="sub-question">Que equipamento de impressora Ã© usado?</div>
                    <div class="sub-question">Taxa de erro ou falta de etiqueta?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva o processo de etiquetagem</label>
                        <textarea name="r7_descricao" placeholder="Processo, equipamento, taxa de erro..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ–¨ï¸ Tipo de impressora</label>
                        <input type="text" name="r7_impressora" placeholder="Ex: Zebra GK420, Datamax, TÃ©rmica...">
                    </div>

                    <div class="form-group">
                        <label class="form-label">âš™ï¸ NÃ­vel de automaÃ§Ã£o</label>
                        <select name="r7_automacao" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="100">100% automÃ¡tico - imprime quando material entra</option>
                            <option value="75">75% - operador clica para imprimir</option>
                            <option value="50">50% - sistema gera, mas impressÃ£o manual</option>
                            <option value="25">25% - operador cria etiqueta manualmente</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> MÃ©dio - gera retrabalho e perda de rastreabilidade
                    </div>
                </div>

                <div class="navigation">
                    <button type="button" class="btn btn-secondary" onclick="switchTab('etapa1')">â† Anterior</button>
                    <button type="button" class="btn btn-primary" onclick="switchTab('etapa3')">PrÃ³xima â†’</button>
                </div>
            </form>
        </div>

        <div id="etapa3" class="content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“Œ Etapa 3: Tratamento de DivergÃªncias</h2>
            <button class="print-section-btn" type="button" onclick="exportSectionAsHtml('etapa3', 'Etapa 3: Tratamento de DivergÃªncias')">ğŸ“„ Salvar PDF desta etapa</button>


            <div class="form-group section-interviewee">
                <label class="form-label" style="color: #1565c0; margin-bottom: 5px;">ğŸ‘¤ Entrevistado desta SeÃ§Ã£o:</label>
                <input type="text" name="entrevistado_etapa3" placeholder="Nome de quem respondeu esta etapa">
            </div>

            <div class="progress-bar"><div class="progress-fill" style="width: 43%;"></div></div>

            <form id="form3">
                <div class="question-card">
                    <div class="question-id">R8</div>
                    <div class="question-title">Como sÃ£o registradas e comunicadas divergÃªncias?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva o processo</label>
                        <textarea name="r8_descricao" placeholder="Registro, comunicaÃ§Ã£o, rastreamento..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“Š Volume de divergÃªncias/mÃªs</label>
                        <input type="number" name="r8_volume" placeholder="Ex: 15">
                    </div>

                    <div class="form-group">
                        <label class="form-label">â±ï¸ Tempo mÃ©dio de resoluÃ§Ã£o (dias)</label>
                        <input type="number" name="r8_tempo" placeholder="Ex: 3">
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> Alto - impacta financeiro e fiscal
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R9</div>
                    <div class="question-title">Como Ã© gerenciada a carga avariada?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva o processo</label>
                        <textarea name="r9_descricao" placeholder="Registro, integraÃ§Ã£o com QA, tempo..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“Š Volume de avarias/mÃªs</label>
                        <input type="number" name="r9_volume" placeholder="Ex: 5">
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> MÃ©dio - impacta qualidade e custos
                    </div>
                </div>

                <div class="navigation">
                    <button type="button" class="btn btn-secondary" onclick="switchTab('etapa2')">â† Anterior</button>
                    <button type="button" class="btn btn-primary" onclick="switchTab('etapa4')">PrÃ³xima â†’</button>
                </div>
            </form>
        </div>

        <div id="etapa4" class="content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“Œ Etapa 4: Armazenagem e ExpediÃ§Ã£o</h2>
            <button class="print-section-btn" type="button" onclick="exportSectionAsHtml('etapa4', 'Etapa 4: Armazenagem e ExpediÃ§Ã£o')">ğŸ“„ Salvar PDF desta etapa</button>


            <div class="form-group section-interviewee">
                <label class="form-label" style="color: #1565c0; margin-bottom: 5px;">ğŸ‘¤ Entrevistado desta SeÃ§Ã£o:</label>
                <input type="text" name="entrevistado_etapa4" placeholder="Nome de quem respondeu esta etapa">
            </div>

            <div class="progress-bar"><div class="progress-fill" style="width: 57%;"></div></div>

            <form id="form4">
                <div class="question-card">
                    <div class="question-id">R11</div>
                    <div class="question-title">Como funciona o picking/separaÃ§Ã£o?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva o processo</label>
                        <textarea name="r11_descricao" placeholder="Sistema gera picking, uso de coletor, taxa de erro..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">âš™ï¸ NÃ­vel de automaÃ§Ã£o</label>
                        <select name="r11_automacao" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="100">100% automatizado</option>
                            <option value="75">75% - sistema define, coletor valida</option>
                            <option value="50">50% - misto</option>
                            <option value="25">25% - mais manual que automÃ¡tico</option>
                            <option value="0">0% - totalmente manual</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“Š Taxa de erro de picking (%)</label>
                        <input type="number" name="r11_taxa_erro" placeholder="Ex: 1.5" min="0" max="100">
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> Alto - impacta faturamento e satisfaÃ§Ã£o do cliente
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R12</div>
                    <div class="question-title">Como funciona a integraÃ§Ã£o EWM?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva o fluxo</label>
                        <textarea name="r12_descricao" placeholder="IntegraÃ§Ã£o OES-EWM, latÃªncia, sincronizaÃ§Ã£o..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ”„ Tipo de integraÃ§Ã£o</label>
                        <select name="r12_integracao" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="real-time">Real-time - instantÃ¢nea</option>
                            <option value="batch-5">Batch 5 min</option>
                            <option value="batch-30">Batch 30 min</option>
                            <option value="batch-60">Batch 1 hora</option>
                            <option value="manual">Manual/nÃ£o integrado</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> Alto - atraso em operaÃ§Ãµes de separaÃ§Ã£o
                    </div>
                </div>

                <div class="navigation">
                    <button type="button" class="btn btn-secondary" onclick="switchTab('etapa3')">â† Anterior</button>
                    <button type="button" class="btn btn-primary" onclick="switchTab('etapa5')">PrÃ³xima â†’</button>
                </div>
            </form>
        </div>

        <div id="etapa5" class="content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“Œ Etapa 5: InventÃ¡rio e Fechamento</h2>
            <button class="print-section-btn" type="button" onclick="exportSectionAsHtml('etapa5', 'Etapa 5: InventÃ¡rio e Fechamento')">ğŸ“„ Salvar PDF desta etapa</button>


            <div class="form-group section-interviewee">
                <label class="form-label" style="color: #1565c0; margin-bottom: 5px;">ğŸ‘¤ Entrevistado desta SeÃ§Ã£o:</label>
                <input type="text" name="entrevistado_etapa5" placeholder="Nome de quem respondeu esta etapa">
            </div>

            <div class="progress-bar"><div class="progress-fill" style="width: 71%;"></div></div>

            <form id="form5">
                <div class="question-card">
                    <div class="question-id">R13</div>
                    <div class="question-title">Como Ã© realizado o inventÃ¡rio fÃ­sico?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva o processo</label>
                        <textarea name="r13_descricao" placeholder="MÃ©todo, frequÃªncia, tempo, divergÃªncias..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">âš™ï¸ NÃ­vel de automaÃ§Ã£o (RFID, scanner, etc)</label>
                        <select name="r13_automacao" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="100">100% automatizado (RFID contÃ­nuo)</option>
                            <option value="75">75% - scanner, validaÃ§Ã£o automÃ¡tica</option>
                            <option value="50">50% - scanner manual + validaÃ§Ã£o</option>
                            <option value="25">25% - anotaÃ§Ã£o + digitaÃ§Ã£o posterior</option>
                            <option value="0">0% - totalmente manual</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">â±ï¸ Tempo por inventÃ¡rio (horas)</label>
                        <input type="number" name="r13_tempo" placeholder="Ex: 40">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“Š Taxa de divergÃªncia (%)</label>
                        <input type="number" name="r13_divergencia" placeholder="Ex: 1.2" min="0" max="100">
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> MÃ©dio - impacta fechamento contÃ¡bil
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R14</div>
                    <div class="question-title">Como Ã© gerado relatÃ³rio de material em trÃ¢nsito?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva o processo</label>
                        <textarea name="r14_descricao" placeholder="AutomÃ¡tico ou manual, frequÃªncia, erros..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">âš™ï¸ Tipo de geraÃ§Ã£o</label>
                        <select name="r14_tipo" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="100">100% automÃ¡tico - sistema gera e envia</option>
                            <option value="75">75% - sistema gera, operador envia</option>
                            <option value="50">50% - sistema extrai, operador processa</option>
                            <option value="25">25% - operador coleta dados e monta</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> Alto - impacta contabilidade e fechamento mensal
                    </div>
                </div>

                <div class="navigation">
                    <button type="button" class="btn btn-secondary" onclick="switchTab('etapa4')">â† Anterior</button>
                    <button type="button" class="btn btn-primary" onclick="switchTab('etapa6')">PrÃ³xima â†’</button>
                </div>
            </form>
        </div>

        <div id="etapa6" class="content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“Œ Etapa 6: Infraestrutura e Suporte</h2>
            <button class="print-section-btn" type="button" onclick="exportSectionAsHtml('etapa6', 'Etapa 6: Infraestrutura e Suporte')">ğŸ“„ Salvar PDF desta etapa</button>


            <div class="form-group section-interviewee">
                <label class="form-label" style="color: #1565c0; margin-bottom: 5px;">ğŸ‘¤ Entrevistado desta SeÃ§Ã£o:</label>
                <input type="text" name="entrevistado_etapa6" placeholder="Nome de quem respondeu esta etapa">
            </div>

            <div class="progress-bar"><div class="progress-fill" style="width: 86%;"></div></div>

            <form id="form6">
                <div class="question-card">
                    <div class="question-id">R15</div>
                    <div class="question-title">Qual Ã© o estado dos coletores/PDA?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva o estado dos equipamentos</label>
                        <textarea name="r15_descricao" placeholder="Marca/modelo, idade, taxa de falha..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ–¥ï¸ Marca e modelo dos coletores</label>
                        <input type="text" name="r15_modelo" placeholder="Ex: Zebra MC33, Datalogic, Symbol...">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“Š Taxa de falha/manutenÃ§Ã£o mensal (%)</label>
                        <input type="number" name="r15_taxa_falha" placeholder="Ex: 5" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">âš ï¸ Criticidade do estado dos equipamentos</label>
                        <select name="r15_criticidade" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="1">1 - Ã“timo - equipamentos novos e funcionando</option>
                            <option value="2">2 - Bom - alguns equipamentos antigos mas funcionando</option>
                            <option value="3">3 - MÃ©dio - falhas ocasionais</option>
                            <option value="4">4 - Ruim - frequentes manutenÃ§Ãµes</option>
                            <option value="5">5 - CrÃ­tico - nÃ£o funciona ou sem equipamento</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> Alto - paralisa operaÃ§Ãµes se todos falharem
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R16</div>
                    <div class="question-title">Qual Ã© a confiabilidade da infraestrutura de rede?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva a infraestrutura</label>
                        <textarea name="r16_descricao" placeholder="SLA, redundÃ¢ncia, tempo de resoluÃ§Ã£o, plano DR..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“Š SLA de disponibilidade (%)</label>
                        <input type="number" name="r16_sla" placeholder="Ex: 99.5" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">âš™ï¸ HÃ¡ redundÃ¢ncia/failover?</label>
                        <select name="r16_redundancia">
                            <option value="">-- Selecione --</option>
                            <option value="sim">Sim - hÃ¡ backup automÃ¡tico</option>
                            <option value="parcial">Parcial - redundÃ¢ncia em alguns pontos</option>
                            <option value="nao">NÃ£o - sem redundÃ¢ncia</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">â±ï¸ MTTR (tempo mÃ©dio de resoluÃ§Ã£o, minutos)</label>
                        <input type="number" name="r16_mttr" placeholder="Ex: 30">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ”„ Plano de Disaster Recovery?</label>
                        <select name="r16_dr" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="testado">Sim - testado regularmente</option>
                            <option value="existe">Sim - existe mas nÃ£o testado</option>
                            <option value="incompleto">Incompleto - existe para alguns sistemas</option>
                            <option value="nao">NÃ£o - sem plano</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> CrÃ­tico - paralisa toda operaÃ§Ã£o
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R17</div>
                    <div class="question-title">Existem sistemas satÃ©lites nÃ£o oficiais?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Liste planilhas ou apps paralelos em uso</label>
                        <textarea name="r17_descricao" placeholder="Planilhas Excel, apps informais, motivos..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“Š Quantidade de planilhas em uso</label>
                        <input type="number" name="r17_quantidade" placeholder="Ex: 5">
                    </div>

                    <div class="form-group">
                        <label class="form-label">âš ï¸ Risco de perda de dados</label>
                        <select name="r17_risco" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="1">1 - Baixo - backup existe</option>
                            <option value="2">2 - MÃ©dio - backup ocasional</option>
                            <option value="3">3 - Alto - sem backup consistente</option>
                            <option value="4">4 - CrÃ­tico - sem backup nenhum</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> MÃ©dio - falta de rastreabilidade e risco de dados
                    </div>
                </div>

                <div class="navigation">
                    <button type="button" class="btn btn-secondary" onclick="switchTab('etapa5')">â† Anterior</button>
                    <button type="button" class="btn btn-primary" onclick="switchTab('etapa7')">PrÃ³xima â†’</button>
                </div>
            </form>
        </div>

        <div id="etapa7" class="content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ“Œ Etapa 7: AnÃ¡lise e RelatÃ³rios</h2>
            <button class="print-section-btn" type="button" onclick="exportSectionAsHtml('etapa7', 'Etapa 7: AnÃ¡lise e RelatÃ³rios')">ğŸ“„ Salvar PDF desta etapa</button>

            
            <div class="form-group section-interviewee">
                <label class="form-label" style="color: #1565c0; margin-bottom: 5px;">ğŸ‘¤ Entrevistado desta SeÃ§Ã£o:</label>
                <input type="text" name="entrevistado_etapa7" placeholder="Nome de quem respondeu esta etapa">
            </div>

            <div class="progress-bar"><div class="progress-fill" style="width: 100%;"></div></div>

            <form id="form7">
                <div class="question-card">
                    <div class="question-id">R18</div>
                    <div class="question-title">Quais relatÃ³rios/dashboards estÃ£o em uso?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Liste os relatÃ³rios existentes</label>
                        <textarea name="r18_descricao" placeholder="RelatÃ³rios, dashboards, frequÃªncia de atualizaÃ§Ã£o, KPIs..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ”„ FrequÃªncia de atualizaÃ§Ã£o dos dados</label>
                        <select name="r18_frequencia" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="real-time">Real-time - sempre atualizado</option>
                            <option value="10min">10 minutos</option>
                            <option value="1hora">1 hora</option>
                            <option value="1dia">1 dia</option>
                            <option value="manual">Manual - gerado sob demanda</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> MÃ©dio - visibilidade gerencial
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-id">R19</div>
                    <div class="question-title">HÃ¡ visibilidade em tempo real de problemas?</div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ Descreva o monitoramento atual</label>
                        <textarea name="r19_descricao" placeholder="Alertas, visibilidade, integraÃ§Ã£o entre sistemas..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">âš ï¸ Sistema emite alertas automÃ¡ticos?</label>
                        <select name="r19_alertas" onchange="updateRiskMatrix()">
                            <option value="">-- Selecione --</option>
                            <option value="sim">Sim - alertas automÃ¡ticos em tempo real</option>
                            <option value="parcial">Parcial - alguns alertas apenas</option>
                            <option value="nao">NÃ£o - sem alertas automÃ¡ticos</option>
                        </select>
                    </div>

                    <div class="impacto-info">
                        <strong>ğŸ’¡ Impacto esperado:</strong> MÃ©dio - reatividade a problemas
                    </div>
                </div>

                <div class="question-card" style="background: #f9f9f9;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">ğŸ“‹ Fechamento</h3>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ“… Data de Preenchimento (Geral)</label>
                        <input type="date" name="data_entrevista" id="dataEntrevista" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ğŸ“ ObservaÃ§Ãµes Finais (Geral)</label>
                        <textarea name="observacoes_finais" placeholder="Qualquer comentÃ¡rio, prioridades, sugestÃµes..."></textarea>
                    </div>
                </div>

                <div class="navigation">
                    <button type="button" class="btn btn-secondary" onclick="switchTab('etapa6')">â† Anterior</button>
                    <button type="button" class="btn btn-success" onclick="reviewAnswers()">âœ“ Revisar e Confirmar</button>
                </div>
            </form>
        </div>

        <div id="reviewScreen" class="review-screen">
            <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ” RevisÃ£o das Respostas</h2>

            <div class="review-summary" id="reviewContent">
            </div>

            <div class="navigation">
                <button type="button" class="btn btn-secondary" onclick="backToForm()">â† Corrigir Dados</button>
                <button type="button" class="btn btn-success" onclick="generateReport()">âœ“ Gerar RelatÃ³rio Final</button>
            </div>
        </div>

        <div id="reportScreen" class="report-screen">
            <div id="reportContent">
            </div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
                <button class="print-btn" onclick="generateAndPrintFinalReport()">ğŸ–¨ï¸ Gerar PDF / Imprimir (FINAL)</button>
                <button class="btn btn-secondary" style="margin-left: 10px;" onclick="newInterview()">ğŸ”„ Nova Entrevista (Limpar Dados)</button>
            </div>
        </div>
    </div>
    
    <div id="tempPrintSection" style="display: none;"></div> 

    <script>
        const STORAGE_KEY = 'currentSurveyData';
        let formData = {};

        // --- INICIALIZAÃ‡ÃƒO ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocalStorage();
            attachAutoSave();
            updateRiskMatrix();
        });
        
        // --- FUNÃ‡Ã•ES DE SALVAMENTO ---

        function saveDataToLocalStorage() {
            let currentData = {};
            document.querySelectorAll('form, .content').forEach(container => {
                container.querySelectorAll('input, textarea, select').forEach(field => {
                    if (field.name) {
                        currentData[field.name] = field.value;
                    }
                });
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(currentData));
            formData = currentData;
        }

        function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) {
                // Define a data atual se nÃ£o houver dados salvos
                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0'); // Janeiro Ã© 0
                const yyyy = today.getFullYear();
                document.getElementById('dataEntrevista').value = `${yyyy}-${mm}-${dd}`;
                return;
            }
            
            const data = JSON.parse(savedData);
            formData = data;
            
            for (const [key, value] of Object.entries(data)) {
                const field = document.getElementsByName(key)[0];
                if (field) {
                    field.value = value;
                }
            }
        }

        function attachAutoSave() {
            document.querySelectorAll('input, textarea, select').forEach(element => {
                element.addEventListener('change', saveDataToLocalStorage);
            });
        }


        // --- NAVEGAÃ‡ÃƒO E REVISÃƒO ---

        function switchTab(tabId) {
            saveDataToLocalStorage();
            
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');

            const tabName = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
            if (tabName) tabName.classList.add('active');

            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function getFieldLabel(key, field) {
            let label = null;
            
            const labelMap = {
                'entrevistado_etapa1': 'ğŸ‘¤ Entrevistado - Etapa 1',
                'entrevistado_etapa2': 'ğŸ‘¤ Entrevistado - Etapa 2',
                'entrevistado_etapa3': 'ğŸ‘¤ Entrevistado - Etapa 3',
                'entrevistado_etapa4': 'ğŸ‘¤ Entrevistado - Etapa 4',
                'entrevistado_etapa5': 'ğŸ‘¤ Entrevistado - Etapa 5',
                'entrevistado_etapa6': 'ğŸ‘¤ Entrevistado - Etapa 6',
                'entrevistado_etapa7': 'ğŸ‘¤ Entrevistado - Etapa 7',
                'data_entrevista': 'ğŸ“… Data de Preenchimento (Geral)',
                'observacoes_finais': 'ğŸ“ ObservaÃ§Ãµes Finais (Geral)'
            };
            
            label = labelMap[key];
            if (label) return label;

            if (field) {
                const formGroup = field.closest('.form-group');
                if (formGroup) {
                    const labelEl = formGroup.querySelector('.form-label');
                    if (labelEl) {
                        label = labelEl.innerText.trim();
                    }
                }
            }

            if (!label && field) {
                const questionCard = field.closest('.question-card');
                if(questionCard) {
                    const questionTitle = questionCard.querySelector('.question-title');
                    const questionId = questionCard.querySelector('.question-id');
                    const prefix = questionId ? questionId.innerText + ': ' : '';
                    const fieldLabelText = field.closest('.form-group') && field.closest('.form-group').querySelector('.form-label') ? field.closest('.form-group').querySelector('.form-label').innerText.replace(/ğŸ“|ğŸ“Š|ğŸ“¡|âš™ï¸|ğŸ–¨ï¸|ğŸ–¥ï¸|ğŸ”„|âš ï¸|â±ï¸/g, '').trim() : '';

                    if (questionTitle) {
                        let baseTitle = questionTitle.innerText;
                        
                        if (fieldLabelText && !baseTitle.includes(fieldLabelText) && 
                            fieldLabelText !== 'ğŸ“ Descreva o processo' && fieldLabelText !== 'ğŸ“ Descreva o estado dos equipamentos' && fieldLabelText !== 'ğŸ“ Descreva a infraestrutura') {
                            baseTitle += ' (' + fieldLabelText + ')';
                        }
                        
                        label = prefix + baseTitle;
                    }
                }
            }
            
            return label || key.toUpperCase();
        }
        
        function getFieldDisplayValue(key, field) {
            let value = formData[key] || '';
            let displayValue = value;
            if (key === 'data_entrevista' && value) {
                 try {
                    // Formata a data de yyyy-mm-dd para dd/mm/yyyy
                    const [year, month, day] = value.split('-');
                    return `${day}/${month}/${year}`;
                } catch (e) {
                    return value; // Retorna o valor original se a formataÃ§Ã£o falhar
                }
            } else if (field && field.tagName === 'SELECT') {
                const selectedOption = field.options[field.selectedIndex];
                if (selectedOption) {
                    displayValue = selectedOption.text;
                }
            }
            return displayValue;
        }

        // Ajustada para ser re-utilizÃ¡vel (reviewAnswers(true) para uso silencioso)
        function reviewAnswers(silent = false) {
            saveDataToLocalStorage();
            
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) {
                if (!silent) alert('Erro: NÃ£o foi possÃ­vel ler os dados salvos.');
                return;
            }
            formData = JSON.parse(savedData);
            
            let reviewHTML = '';
            
            const allFields = document.querySelectorAll('input, textarea, select');
            
            allFields.forEach(field => {
                const key = field.name;
                const value = formData[key] || '';
                
                // Exclui campos de entrevista para evitar duplicaÃ§Ã£o no review final, eles serÃ£o tratados no topo do relatÃ³rio
                if (key && key.startsWith('entrevistado_')) return; 

                if (value && value.trim() !== '') {
                    const label = getFieldLabel(key, field);
                    const displayValue = getFieldDisplayValue(key, field);

                    reviewHTML += `
                        <div class="review-item">
                            <div class="review-item-title">${escapeHtml(label)}</div>
                            <div class="review-item-value">${escapeHtml(displayValue)}</div>
                        </div>
                    `;
                }
            });

            document.getElementById('reviewContent').innerHTML = reviewHTML;
            
            if (!silent) {
                document.getElementById('reviewScreen').classList.add('active');
                document.getElementById('tabSystem').style.display = 'none';
                document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        }

        function backToForm() {
            document.getElementById('reviewScreen').classList.remove('active');
            document.getElementById('tabSystem').style.display = 'flex';
            switchTab('etapa7');
        }
        
        // --- MÃ‰TODO PARA IMPRESSÃƒO DE SEÃ‡ÃƒO (Backup) ---

        function exportSectionAsHtml(sectionId, sectionTitle) {
            saveDataToLocalStorage();
            const section = document.getElementById(sectionId);
            
            if (!section) {
                alert('Erro: SeÃ§Ã£o nÃ£o encontrada.');
                return;
            }

            const intervieweField = document.querySelector(`input[name="entrevistado_${sectionId}"]`);
            const interviewedName = intervieweField ? intervieweField.value || 'NÃƒO INFORMADO' : 'NÃƒO INFORMADO';
            
            const sectionFields = section.querySelectorAll('input, textarea, select');
            let reviewHTML = '';
            
            sectionFields.forEach(field => {
                const key = field.name;
                const value = formData[key] || '';
                
                if (key === `entrevistado_${sectionId}`) return; 
                
                if (value && value.trim() !== '') {
                    const label = getFieldLabel(key, field);
                    const displayValue = getFieldDisplayValue(key, field);

                    reviewHTML += `
                        <div class="review-item" style="margin-bottom: 10px; padding: 10px; border-left: 4px solid #2a5298; background: #f0f7ff; border-radius: 4px;">
                            <div class="review-item-title" style="font-weight: bold; color: #1e3c72; font-size: 13px; margin-bottom: 3px;">${escapeHtml(label)}</div>
                            <div class="review-item-value" style="color: #333; font-size: 12px; white-space: pre-wrap;">${escapeHtml(displayValue)}</div>
                        </div>
                    `;
                }
            });
            
            if (reviewHTML === '') {
                alert('AtenÃ§Ã£o: Esta etapa nÃ£o tem respostas preenchidas para salvar. Preencha os dados primeiro.');
                return;
            }

            // 2. Cria o conteÃºdo temporÃ¡rio para impressÃ£o usando o elemento `#tempPrintSection`
            const printContent = document.getElementById('tempPrintSection');
            printContent.innerHTML = `
                <div class="backup-section-content" style="padding: 20px; max-width: 800px; margin: 0 auto; background: white;">
                    <div class="backup-header" style="background: #1e3c72; color: white; padding: 20px; border-radius: 6px 6px 0 0; margin-bottom: 20px; text-align: center;">
                        <h1 style="font-size: 24px; margin: 0;">Backup - Mapeamento TecnolÃ³gico</h1>
                        <p>${escapeHtml(sectionTitle)}</p>
                    </div>
                    
                    <div class="interviewee-info" style="background: #fff3cd; padding: 10px; border-radius: 4px; border-left: 4px solid #ff9800; margin-bottom: 20px; font-weight: bold; color: #333; font-size: 14px;">
                        Entrevistado: ${escapeHtml(interviewedName)} | Data do Backup: ${new Date().toLocaleDateString('pt-BR')}
                    </div>
                    
                    ${reviewHTML}
                    
                    <div style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 10px; font-size: 10px; color: #999; text-align: center;">
                        Documento de Backup Gerado pelo Sistema de Mapeamento.
                    </div>
                </div>
            `;
            
            // 3. Temporariamente oculta o conteÃºdo principal e mostra o temporÃ¡rio
            document.querySelector('.container').style.display = 'none';
            printContent.style.display = 'block'; 
            
            // 4. Aciona a impressÃ£o 
            setTimeout(() => {
                window.print();
                
                // 5. Restaura a visualizaÃ§Ã£o da tela
                setTimeout(() => {
                    printContent.style.display = 'none'; // Esconde o conteÃºdo temporÃ¡rio
                    printContent.innerHTML = ''; // Limpa
                    document.querySelector('.container').style.display = 'block'; // Mostra o container
                    document.getElementById(sectionId).classList.add('active'); 
                }, 500); 
                
            }, 300);

            alert(`Preparando PDF da ${sectionTitle}. Aguarde o diÃ¡logo de impressÃ£o aparecer e selecione "Salvar como PDF".`);
        }


        // --- FUNÃ‡ÃƒO CRÃTICA FINAL: GERA E IMPRIME O RELATÃ“RIO FINAL ---
        
        function generateAndPrintFinalReport() {
            // 1. Garante que o Report Content esteja na tela e com os dados corretos
            // O isSilent=true garante que nÃ£o vamos travar a tela com a transiÃ§Ã£o duplicada
            generateReport(true); 

            // 2. Oculta o elemento de impressÃ£o de seÃ§Ã£o para que o CSS de impressÃ£o final funcione
            document.getElementById('tempPrintSection').style.display = 'none';

            // 3. Aciona a impressÃ£o (com atraso para estabilidade)
            setTimeout(() => {
                window.print();
                
                // 4. Restaura a visualizaÃ§Ã£o da tela
                setTimeout(() => {
                    // Mantemos a tela de relatÃ³rio ativa para o usuÃ¡rio.
                    document.getElementById('reportScreen').classList.add('active'); 
                }, 500);
                
            }, 300);

            alert(`Preparando PDF do RelatÃ³rio Final. Aguarde o diÃ¡logo de impressÃ£o aparecer e selecione "Salvar como PDF".`);
        }


        // CORREÃ‡ÃƒO APLICADA AQUI: Simplifica a lÃ³gica e garante que o review seja atualizado antes
        function generateReport(isSilent = false) {
            // 1. Garante que o conteÃºdo de revisÃ£o esteja pronto. (silent=true para nÃ£o tentar mostrar a tela de revisÃ£o, que jÃ¡ estÃ¡ visÃ­vel ou deve ser ignorada)
            reviewAnswers(true); 

            // 2. Calcula criticidades e monta o HTML do relatÃ³rio.
            const criticidades = calculateCriticalities();
            const reportHTML = buildReport(criticidades);

            // 3. Insere o HTML e faz a transiÃ§Ã£o de tela.
            document.getElementById('reportContent').innerHTML = reportHTML;
            document.getElementById('reportScreen').classList.add('active');
            document.getElementById('reviewScreen').classList.remove('active');
            document.getElementById('tabSystem').style.display = 'none';

            if (!isSilent) {
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        }

        function newInterview() {
            if (confirm('Deseja iniciar uma nova entrevista? O progresso atual serÃ¡ perdido. Certifique-se de que salvou o PDF da entrevista anterior.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // --- LÃ“GICA DO RELATÃ“RIO (CRITICIDADES) ---

        function calculateCriticalities() {
            saveDataToLocalStorage();
            
            const criticidades = {};
            criticidades.r1 = calculateGapCriticality('r1_frequencia', 'Alto');
            criticidades.r4 = calculateGapCriticality('r4_qualidade', 'Alto');
            criticidades.r16 = calculateGapCriticality('r16_dr', 'CrÃ­tico');
            criticidades.r2 = calculateGapCriticality('r2_wifi', 'Medio');
            criticidades.r5 = calculateGapCriticality('r5_automacao', 'Alto');
            criticidades.r11 = calculateGapCriticality('r11_automacao', 'Alto');
            criticidades.r13 = calculateGapCriticality('r13_automacao', 'Medio');
            criticidades.r15 = calculateGapCriticality('r15_criticidade', 'Alto');
            criticidades.r17 = calculateGapCriticality('r17_risco', 'Medio');

            return criticidades;
        }

        function calculateGapCriticality(fieldName, expectedImpact) {
            const value = (formData[fieldName] || '').toLowerCase();
            
            const criticalityMap = {
                // Alto/CrÃ­tico (4-5)
                'critico': 5, 'ruim': 4, 'frequente': 4, 'nao': 5, '4': 5, '5': 5, 'menos75': 5, '0': 5, 
                'manual': 5, 'batch-diario': 4, 'batch-60': 4, '25': 4,
                // MÃ©dio (3)
                'ocasional': 3, 'medio': 3, 'existe': 3, 'parcial': 3, '3': 3, 'batch-30': 3, '50': 3,
                // Baixo (1-2)
                'raro': 2, 'bom': 2, '75': 2, '2': 2, 'batch-5': 2, '95': 2,
                'nenhum': 1, 'excelente': 1, '100': 1, 'testado': 1, '1': 1, 'real-time': 1,
            };
            
            let critValue = criticalityMap[value] || 1;
            
            if (fieldName === 'r17_risco') {
                const riskMap = { '4': 5, '3': 4, '2': 3, '1': 1 };
                critValue = riskMap[value] || 1;
            }
            
             if (fieldName === 'r5_automacao' || fieldName === 'r11_automacao') {
                if (value === '0') critValue = 5; 
                if (value === '25') critValue = 4;
            }

            return critValue;
        }

        function buildReport(criticidades) {
            const data = getFieldDisplayValue('data_entrevista', document.getElementsByName('data_entrevista')[0]) || 'N/A';

            let entrevistados = '';
            for (let i = 1; i <= 7; i++) {
                const fieldName = `entrevistado_etapa${i}`;
                const nome = formData[fieldName] || 'N/A';
                entrevistados += `<li>**Etapa ${i}:** ${escapeHtml(nome)}</li>`;
            }
            
            const createGapRow = (etapa, id, titulo, impacto) => {
                const critValue = criticidades[id] || 1;
                if (critValue <= 2) return ''; 
                const label = getCriticityLabel(critValue);
                return `
                    <tr>
                        <td>${etapa}</td>
                        <td>${id.toUpperCase()}</td>
                        <td style="text-align: left;">${titulo}</td>
                        <td><span class="gap-criticality criticality-${label}">${label.toUpperCase()} (${critValue})</span></td>
                        <td style="text-align: left;">${impacto}</td>
                    </tr>`;
            };

            let html = `
                <div class="report-title">ğŸ“Š MAPEAMENTO TECNOLÃ“GICO - RELATÃ“RIO EXECUTIVO</div>

                <div class="report-section" style="border: 2px solid #ddd; padding: 20px; border-radius: 8px;">
                     <div class="report-section-title" style="border-left-color: var(--info);">SumÃ¡rio do Mapeamento</div>
                     <p><strong>Local:</strong> Planta TatuÃ­ | <strong>Foco:</strong> Recebimento & ExpediÃ§Ã£o</p>
                     <p><strong>Data de ReferÃªncia:</strong> ${escapeHtml(data)}</p>
                     <br>
                     <p><strong>Entrevistados:</strong></p>
                     <ul style="list-style-type: none; padding-left: 0; font-size: 13px;">${entrevistados}</ul>
                </div>

                <div class="report-section">
                    <div class="report-section-title">ğŸ¯ Gaps e Criticidades Identificados (Priorizados)</div>
                    <p style="font-size: 13px; margin-bottom: 10px; color: #666;">Apenas gaps com Criticidade MÃ©dia (3) ou Alta (4-5) estÃ£o listados abaixo.</p>
                    <table class="risk-matrix">
                        <thead>
                            <tr>
                                <th>Etapa</th>
                                <th>ID</th>
                                <th style="width: 35%;">Gap Identificado</th>
                                <th>Criticidade</th>
                                <th style="width: 35%;">Impacto</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${createGapRow(1, 'r1', 'IntegraÃ§Ã£o NF-e (Cockpit Edoc) com erros/atrasos', 'Alto - Atraso em todo processo de recebimento')}
                            ${createGapRow(1, 'r2', 'Qualidade da ConexÃ£o Wi-Fi na Portaria', 'MÃ©dio - Atraso de registro')}
                            ${createGapRow(2, 'r4', 'Cobertura Wi-Fi no Almoxarifado (Pontos Cegos)', 'Alto - Paralisa operaÃ§Ãµes de conferÃªncia')}
                            ${createGapRow(2, 'r5', 'Baixo NÃ­vel de AutomaÃ§Ã£o na ConferÃªncia ABC', 'Alto - Impacta acuracidade de estoque')}
                            ${createGapRow(4, 'r11', 'Baixo NÃ­vel de AutomaÃ§Ã£o no Picking/SeparaÃ§Ã£o', 'Alto - Impacta faturamento e satisfaÃ§Ã£o do cliente')}
                            ${createGapRow(5, 'r13', 'Baixo NÃ­vel de AutomaÃ§Ã£o/Scanner no InventÃ¡rio', 'MÃ©dio - Impacta fechamento contÃ¡bil')}
                            ${createGapRow(6, 'r15', 'Estado de ConservaÃ§Ã£o dos Coletores/PDA', 'Alto - Paralisa operaÃ§Ãµes se houver quebra')}
                            ${createGapRow(6, 'r16', 'AusÃªncia ou Falha no Plano de Disaster Recovery (DR)', 'CrÃ­tico - Paralisa toda operaÃ§Ã£o de TI')}
                            ${createGapRow(6, 'r17', 'Uso de "Sistemas SatÃ©lite" (Planilhas) nÃ£o oficiais', 'MÃ©dio - Falta de rastreabilidade e risco de dados')}
                        </tbody>
                    </table>
                </div>

                <div class="report-section">
                    <div class="report-section-title">ğŸ”§ RecomendaÃ§Ãµes Imediatas (Baseado nos Gaps)</div>
                    <ul style="margin-left: 20px;">
                        <li><strong>(CrÃ­tico) R16:</strong> Definir e testar **urgentemente** um Plano de Disaster Recovery para sistemas crÃ­ticos, com foco em restauraÃ§Ã£o rÃ¡pida.</li>
                        <li><strong>(Alto) R4, R1:</strong> Realizar **site survey de Wi-Fi** detalhado no Almoxarifado e Portaria; auditar e corrigir falhas de **integraÃ§Ã£o NF-e**.</li>
                        <li><strong>(Alto) R5, R11, R15:</strong> Iniciar projeto de **automaÃ§Ã£o** de processos (ConferÃªncia ABC e Picking) migrando para coletores 100% via sistema (WMS). Planejar **substituiÃ§Ã£o** ou reparo de PDAs com falhas frequentes.</li>
                        <li><strong>(MÃ©dio) R17:</strong> Inventariar todas as planilhas "satÃ©lite" e migrar dados crÃ­ticos para o sistema ERP/WMS ou plataformas controladas (ex: Power Apps) para **mitigar risco de perda de dados**.</li>
                    </ul>
                </div>

                <div class="report-section">
                    <div class="report-section-title">ğŸ“ Resumo Detalhado das Respostas</div>
                    <div class="review-item" style="background: #fdfdfd; margin-bottom: 20px;">
                        <strong>ObservaÃ§Ãµes Finais:</strong> ${escapeHtml(formData.observacoes_finais || 'N/A')}
                    </div>
                    
                    <div id="reviewSummaryForReport" class="review-summary">
                        </div>
                </div>

                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd; font-size: 12px; color: #999; text-align: center;">
                    <p>RelatÃ³rio gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                    <p>VersÃ£o: 3.2 (CorreÃ§Ã£o Final de Fluxo) | Sistema de Mapeamento TecnolÃ³gico</p>
                </div>
            `;
            
            // Corrige o resumo de revisÃ£o antes de retornar
            document.getElementById('reviewSummaryForReport').innerHTML = document.getElementById('reviewContent').innerHTML;
            
            return html;
        }

        function getCriticityLabel(value) {
            if (value >= 4) return 'alto'; 
            if (value >= 3) return 'medio';
            return 'baixo';
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateRiskMatrix() {
            saveDataToLocalStorage();
        }

    </script>
</body>

</html>
